<?php  require("../dbConfig/config.php");include_once("../models/userModel.php");include_once("../samtogAndroid/version2/sendnotificationAndroid.php");include_once("../models/myConversationModel.php");include_once("../dataModels/commonDataModel.php");function getMyConversationTableData($itemPerPage,$currentPageNumber){$emailId=$_SESSION['emailId'];$data=array();$count=0;$getMsg=mysql_query("select * from personalmessagemain where (StatusFrom='True' || StatusTo='True') && (ToId='$emailId' || FromId='$emailId')");$num=mysql_num_rows($getMsg);if($num>=1){while($rowMsg=mysql_fetch_array($getMsg)){$fromId=$rowMsg['FromId'];$fromStatus=$rowMsg['FromStatus'];$toStatus=$rowMsg['ToStatus'];$StatusFrom=$rowMsg['StatusFrom'];$StatusTo=$rowMsg['StatusTo'];if(strtolower($fromId)==strtolower($emailId)){if($StatusFrom=='True'){if($fromStatus!=1){$count=$count+1;}}}else {if($StatusTo=='True'){if($toStatus!=1){$count=$count+1;}}}}}$query="select * from personalmessagemain where (ToId='$emailId' and ToStatus=0) or (FromId='$emailId' and FromStatus=0) ";$result=mysql_query($query);$noOfRows=mysql_num_rows($result);if(is_resource($result) and $noOfRows<=0){echo json_encode($data);exit;}if($noOfRows<=0){echo json_encode($data);exit;}else {$totalPages=ceil($noOfRows/$itemPerPage);$start=$currentPageNumber*$itemPerPage;$queryPagingData="select * from personalmessagemain where (ToId='$emailId' and ToStatus=0) or (FromId='$emailId' and FromStatus=0) ORDER BY ID DESC LIMIT $start, $itemPerPage";$resultPagingData=mysql_query($queryPagingData) or die('MySql Error'.mysql_error());while($rs=mysql_fetch_assoc($resultPagingData)){$MyConversation=new MyConversationModel();$MyConversation->currentUserEmail=$emailId;$MyConversation->Id=$rs['Id'];$MyConversation->Status=$rs['StatusTo'];$MyConversation->Subject=$rs['Subject'];$MyConversation->FromEmail=$rs['FromId'];$MyConversation->ToEmail=$rs['ToId'];$MyConversation->unread=$count;if(strtolower($rs['FromId'])==strtolower($_SESSION['emailId'])){$MyConversation->Status=$rs['StatusFrom'];}else {$MyConversation->Status=$rs['StatusTo'];}if(strtolower($rs['FromId'])==strtolower($_SESSION['emailId'])){$MyConversation->FromAction=1;}else {$MyConversation->FromAction=0;}if(strtolower($rs['ToId'])==strtolower($_SESSION['emailId'])){$MyConversation->ToAction=1;}else {$MyConversation->ToAction=0;}$user=getUserObject($rs['FromId']);$MyConversation->FromId=$user->ID;$MyConversation->FromUserName=$user->FullName;$user=getUserObject($rs['ToId']);$MyConversation->ToId=$user->ID;$MyConversation->ToUserName=$user->FullName;$num=mysql_num_rows(mysql_query("select * from personalmessagethread where PmId=$rs[Id]"));if($num!=0){$MyConversation->Replies=$num-1;}else {$MyConversation->Replies=$num;}if($num>0){$resultDate=mysql_query("select * from personalmessagethread where PmId=$rs[Id] ORDER BY PostedDate DESC");$numDate=mysql_num_rows($resultDate);$rowDate=mysql_fetch_array($resultDate);$postDate=$rowDate['PostedDate'];$user=getUserObject($rowDate['EmailId']);$MyConversation->ReplyId=$user->ID;$MyConversation->ReplyUserName=$user->FullName;$MyConversation->ReplyEmail=$rowDate['EmailId'];if(strtolower($rowDate['EmailId'])==strtolower($_SESSION['emailId'])){$MyConversation->RplyAction=1;}else {$MyConversation->RplyAction=0;}}else{$user=getUserObject($rs['FromId']);$MyConversation->ReplyId=$user->ID;$MyConversation->ReplyUserName=$user->FullName;$MyConversation->ReplyEmail=$rs['FromId'];if(strtolower($rs['FromId'])==strtolower($_SESSION['emailId'])){$MyConversation->RplyAction=1;}else {$MyConversation->RplyAction=0;}$postDate=$rs['PostedDate'];}$date=explode(" ",$postDate);$date2=explode("-",$date[0]);$getmonth=mysql_query("select * from months");while($getmnth=mysql_fetch_assoc($getmonth)){if($date2[1]==$getmnth['Id'])$month=$getmnth['Months'];}$MyConversation->PostedDate=$date2[2].".".$month.".".$date2[0].", ";$date3=explode(":",$date[1]);if($date3[0]==12){$MyConversation->PostedTime=$date3[0].":".$date3[1]." PM";}else if($date3[0]>12){$time=$date3[0]-12;$MyConversation->PostedTime=$time.":".$date3[1]." PM";}else {$MyConversation->PostedTime=$date3[0].":".$date3[1]." AM";}$MyConversation->TotalPages=$totalPages;array_push($data,$MyConversation);}mysql_free_result($result);mysql_free_result($resultPagingData);echo json_encode($data);}}function actionOnMessage($itemPerPage,$currentPageNumber,$count,$Messageaction){$emailId=$_SESSION['emailId'];$personalMessageId=array();if($count!=""){$mainId=explode(",",$count);foreach($mainId as $pmid){if(strrchr($pmid,"[")){$id=explode("[",$pmid);if(strrchr($id[1],"]")){$id2=explode("]",$id[1]);$messageId=$id2[0];}else {$messageId=$id[1];}}else if(strrchr($pmid,"]")){$id=explode("]",$pmid);$messageId=$id[0];}else {$messageId=$pmid;}array_push($personalMessageId,$messageId);}}if($Messageaction=='Delete'){foreach($personalMessageId as $mId){$row=mysql_fetch_array(mysql_query("select * from personalmessagemain where Id=$mId"));$fromId=$row['FromId'];$fromStatus=$row['FromStatus'];$toStatus=$row['ToStatus'];if($fromStatus==0&&$toStatus==0){if(strtolower($fromId)==strtolower($emailId)){mysql_query("update personalmessagemain set FromStatus=1 where Id=$mId");}else {mysql_query("update personalmessagemain set ToStatus=1 where Id=$mId");}}else {$resultPtId=mysql_query("select * from personalmessagethread where PmId=$mId ");while($getPtId=mysql_fetch_array($resultPtId)){$personalThreadId=$getPtId['Id'];mysql_query("delete from personalmessageattachment where PtId=$personalThreadId");}mysql_query("delete from personalmessagethread where PmId=$mId");mysql_query("delete from personalmessagemain where Id=$mId");}}}else if($Messageaction=='MarkRead'){foreach($personalMessageId as $mId){$row=mysql_fetch_array(mysql_query("select * from personalmessagemain where Id=$mId"));$fromId=$row['FromId'];$fromStatus=$row['FromStatus'];$toStatus=$row['ToStatus'];if(strtolower($fromId)==strtolower($emailId)){mysql_query("update personalmessagemain set StatusFrom='False' where Id=$mId");}else {mysql_query("update personalmessagemain set StatusTo='False' where Id=$mId");}}}else if($Messageaction=='MarkUnread'){foreach($personalMessageId as $mId){$row=mysql_fetch_array(mysql_query("select * from personalmessagemain where Id=$mId"));$fromId=$row['FromId'];$fromStatus=$row['FromStatus'];$toStatus=$row['ToStatus'];if(strtolower($fromId)==strtolower($emailId)){mysql_query("update personalmessagemain set StatusFrom='True' where Id=$mId");}else {mysql_query("update personalmessagemain set StatusTo='True' where Id=$mId");}}}else if($Messageaction=='DeleteRead'){$resultPmId=mysql_query("select * from personalmessagemain where (StatusFrom='False' || StatusTo='False') && (ToId='$emailId' || FromId='$emailId')");while($getPmId=mysql_fetch_array($resultPmId)){$fromId=$getPmId['FromId'];$fromStatus=$getPmId['FromStatus'];$toStatus=$getPmId['ToStatus'];$StatusFrom=$getPmId['StatusFrom'];$StatusTo=$getPmId['StatusTo'];if(strtolower($fromId)==strtolower($emailId)){if($StatusFrom=='False'){if($fromStatus==0&&$toStatus==0){if(strtolower($fromId)==strtolower($emailId)){mysql_query("update personalmessagemain set FromStatus=1 where Id=$getPmId[Id]");}else {mysql_query("update personalmessagemain set ToStatus=1 where Id=$getPmId[Id]");}}else {$resultPtId=mysql_query("select * from personalmessagethread where PmId='$getPmId[Id]' ");while($getPtId=mysql_fetch_array($resultPtId)){$personalThreadId=$getPtId['Id'];mysql_query("delete from personalmessageattachment where PtId=$personalThreadId");}mysql_query("delete from personalmessagethread where PmId='$getPmId[Id]' ");mysql_query("delete from personalmessagemain where Id='$getPmId[Id]' ");}}}else {if($StatusTo=='False'){if($fromStatus==0&&$toStatus==0){if(strtolower($fromId)==strtolower($emailId)){mysql_query("update personalmessagemain set FromStatus=1 where Id=$getPmId[Id]");}else {mysql_query("update personalmessagemain set ToStatus=1 where Id=$getPmId[Id]");}}else {$resultPtId=mysql_query("select * from personalmessagethread where PmId='$getPmId[Id]' ");while($getPtId=mysql_fetch_array($resultPtId)){$personalThreadId=$getPtId['Id'];mysql_query("delete from personalmessageattachment where PtId=$personalThreadId");}mysql_query("delete from personalmessagethread where PmId='$getPmId[Id]' ");mysql_query("delete from personalmessagemain where Id='$getPmId[Id]' ");}}}}}else if($Messageaction=='DeleteUnread'){$resultPmId=mysql_query("select * from personalmessagemain where (StatusFrom='True' || StatusTo='True') && (ToId='$emailId' || FromId='$emailId')");while($getPmId=mysql_fetch_array($resultPmId)){$fromId=$getPmId['FromId'];$fromStatus=$getPmId['FromStatus'];$toStatus=$getPmId['ToStatus'];$StatusFrom=$getPmId['StatusFrom'];$StatusTo=$getPmId['StatusTo'];if(strtolower($fromId)==strtolower($emailId)){if($StatusFrom=='True'){if($fromStatus==0&&$toStatus==0){if(strtolower($fromId)==strtolower($emailId)){mysql_query("update personalmessagemain set FromStatus=1 where Id=$getPmId[Id]");}else {mysql_query("update personalmessagemain set ToStatus=1 where Id=$getPmId[Id]");}}else {$resultPtId=mysql_query("select * from personalmessagethread where PmId='$getPmId[Id]' ");while($getPtId=mysql_fetch_array($resultPtId)){$personalThreadId=$getPtId['Id'];mysql_query("delete from personalmessageattachment where PtId=$personalThreadId");}mysql_query("delete from personalmessagethread where PmId='$getPmId[Id]' ");mysql_query("delete from personalmessagemain where Id='$getPmId[Id]' ");}}}else {if($StatusTo=='True'){if($fromStatus==0&&$toStatus==0){if(strtolower($fromId)==strtolower($emailId)){mysql_query("update personalmessagemain set FromStatus=1 where Id=$getPmId[Id]");}else {mysql_query("update personalmessagemain set ToStatus=1 where Id=$getPmId[Id]");}}else {$resultPtId=mysql_query("select * from personalmessagethread where PmId='$getPmId[Id]' ");while($getPtId=mysql_fetch_array($resultPtId)){$personalThreadId=$getPtId['Id'];mysql_query("delete from personalmessageattachment where PtId=$personalThreadId");}mysql_query("delete from personalmessagethread where PmId='$getPmId[Id]' ");mysql_query("delete from personalmessagemain where Id='$getPmId[Id]' ");}}}}}getMyConversationTableData($itemPerPage,$currentPageNumber);}function getMyConversationThreadTableData($itemPerPage,$currentPageNumber,$PmId){$emailId=$_SESSION['emailId'];$data=array();$MainTopicAction=0;$queryMain="select * from personalmessagemain where Id=$PmId";$resultMain=mysql_query($queryMain);$row=mysql_fetch_array($resultMain);$email=$row['FromId'];if(strtolower($email)==strtolower($emailId)){$MainTopicAction=1;}if(strtolower($email)==strtolower($emailId)){mysql_query("update personalmessagemain set StatusFrom='False' where Id=$PmId");}else {mysql_query("update personalmessagemain set StatusTo='False' where Id=$PmId");}$count=0;$getMsg=mysql_query("select * from personalmessagemain where (StatusFrom='True' || StatusTo='True') && (ToId='$emailId' || FromId='$emailId')");$num=mysql_num_rows($getMsg);if($num>=1){while($rowMsg=mysql_fetch_array($getMsg)){$fromId=$rowMsg['FromId'];$fromStatus=$rowMsg['FromStatus'];$toStatus=$rowMsg['ToStatus'];$StatusFrom=$rowMsg['StatusFrom'];$StatusTo=$rowMsg['StatusTo'];if(strtolower($fromId)==strtolower($emailId)){if($StatusFrom=='True'){if($fromStatus!=1){$count=$count+1;}}}else {if($StatusTo=='True'){if($toStatus!=1){$count=$count+1;}}}}}$query="select * from personalmessagethread where PmId=$PmId ORDER BY Id ASC";$result=mysql_query($query);$rowfirst=mysql_fetch_array($result);$MainPmId=$rowfirst['Id'];$noOfRows=mysql_num_rows($result);if(is_resource($result) and $noOfRows<=0){echo json_encode($data);exit;}if($noOfRows<=0){echo json_encode($data);exit;}else {$totalPages=ceil($noOfRows/$itemPerPage);$start=$currentPageNumber*$itemPerPage;$queryPagingData="select * from personalmessagethread where PmId=$PmId ORDER BY Id ASC LIMIT $start, $itemPerPage";$resultPagingData=mysql_query($queryPagingData) or die('MySql Error'.mysql_error());$resultSubject=mysql_fetch_array(mysql_query("select * from personalmessagemain where Id=$PmId"));while($rs=mysql_fetch_assoc($resultPagingData)){$MyConversation=new MyConversationModel();$MyConversation->MainPmId=$MainPmId;$MyConversation->Id=$rs['Id'];$MyConversation->Subject=$resultSubject['Subject'];$MyConversation->Message=$rs['Message'];$MyConversation->PostedDate=$rs['PostedDate'];$MyConversation->currentUserEmail=$emailId;$MyConversation->unread=$count;$email=strtolower($emailId);$useremail=strtolower($rs['EmailId']);if($email==$useremail){$MyConversation->ThreadAction=1;}$user=getUserObject($rs['EmailId']);$MyConversation->ReplyId=$user->ID;$MyConversation->ReplyUserName=$user->FirstName;if($user->CurrentLivingCity==null||$user->CurrentLivingCity=='null'||$user->CurrentLivingCity==NULL||$user->CurrentLivingCity=='NULL')$MyConversation->CurrentLivingCity='';else $MyConversation->CurrentLivingCity=$user->CurrentLivingCity;$MyConversation->UserPhoto=$user->Photo;$MyConversation->Gender=$user->Gender;$MyConversation->ReplyEmail=$rs['EmailId'];$joinDate=explode(" ",$user->JoinedDate);$MyConversation->JoinedDate=$joinDate[0];$userStatus=$user->Status;$MyConversation->PmId=$PmId;if($userStatus!=0){$MyConversation->UserStatus="Online";}else {$MyConversation->UserStatus="Offline";}$imagesIdArray=array();$imagesArray=array();$imagesSize=array();$imagesType=array();$countImage=0;$resultAttachphoto=mysql_query("select * from personalmessageattachment where PtId=$rs[Id]");$numAttachphoto=mysql_num_rows($resultAttachphoto);if($numAttachphoto>=1){while($rowAttachphoto=mysql_fetch_array($resultAttachphoto)){$image="../attachments/myConversation/".$rowAttachphoto['File'];$imagePath="http://www.samtog.com/attachments/myConversation/".$rowAttachphoto['Image'];if(is_file("../attachments/myConversation/".$row['Image'])){$imagesIdArray[$countImage]=$rowAttachphoto['Id'];$imagesArray[$countImage]=$rowAttachphoto['File'];$imagesSize[$countImage]=filesize($image);$imagesType[$countImage++]=get_mime_type($rowAttachphoto['File']);}}$MyConversation->AttachmentsId=$imagesIdArray;$MyConversation->Attachments=$imagesArray;$MyConversation->AttachmentsSize=$imagesSize;$MyConversation->AttachmentsType=$imagesType;}$MyConversation->TotalPages=$totalPages;$MyConversation->MainAction=$MainTopicAction;array_push($data,$MyConversation);}mysql_free_result($result);mysql_free_result($resultPagingData);echo json_encode($data);}}function addMyConversationThreadData($itemPerPage,$currentPageNumber,$PmId,$topicMessage,$topicAttachment,$dateTime){$emailId=$_SESSION['emailId'];$rowUserName=mysql_fetch_array(mysql_query("select * from users where Email='$emailId'"));$fromUserName=$rowUserName['FirstName']." ".$rowUserName['LastName'];$rowFromEmail=mysql_fetch_array(mysql_query("select * from personalmessagemain where Id='$PmId'"));$subjectAnd=$rowFromEmail['Subject'];if(strtolower($emailId)==strtolower($rowFromEmail['FromId'])){$toEmail=$rowFromEmail['ToId'];mysql_query("update personalmessagemain set StatusTo='True' where Id='$PmId'");}else {$toEmail=$rowFromEmail['FromId'];mysql_query("update personalmessagemain set StatusFrom='True' where Id='$PmId'");}$toUserName=mysql_fetch_array(mysql_query("select * from users where Email='$toEmail'"));sendnotificationmessagethr($emailId,$PmId,$subjectAnd,$topicMessage);$resultNotification=mysql_fetch_array(mysql_query("select * from notifications where EmailId='$toEmail'"));$messageNotification=$resultNotification['MessageNotification'];if($messageNotification==1&&strtolower($toEmail)!=strtolower($emailId)){$to=$toEmail;$message=explode("<p>",$topicMessage);$sendMessage=explode("</p>",$message[1]);$len=ceil(strlen($sendMessage[0])/2);$finalMessage=substr($sendMessage[0],0,$len)."..................";$subject=$fromUserName." Replay on your message!";$mailBody='<html xmlns="http://www.w3.org/1999/xhtml"><body><div id="page" style="border:0 solid #BABABA;max-width:485px;margin:50px auto auto 15px;padding-left:3px;background-color:#FFF;"><div id="header" style="margin:0px;	padding:0px;"><a href="https://samtog.com"><img src="https://samtog.com/images/newsLetterSend/header.png" width="485px"/></a></div><div style="clear:both;"></div><div id="main" style="margin:0px;padding:0px;"><div style="margin:8px 0px;padding-left:10px;cursor:default">Hallo, '.$toUserName['FirstName'].' '.$toUserName['LastName'].'</div><div style="padding-left:30px;cursor:default"><br>You have got a Message From '.$fromUserName.'.<br /><br />'.$finalMessage.'<a href="http://www.samtog.com" style="text-decoration:none;color:#0033FF">Read more</a><br /><br /></div><div style="padding-left:10px;cursor:default"><b>Regards<br />SAMTOG Team</b></div></div></div><div style="clear:both;"></div><div id="footer" style="padding-left:13px;max-width:485px;margin:auto auto auto 15px;background-color:#000;border:1px solid #000;"><div style="width:92%;background:#000;display:table;"><a href="#" style="color: #FFFFFF;float: left;font-size: 12px;margin-left: -12px;margin-top:14px;text-decoration: none;">Follow us:</a><ul style="float: left;list-style: none outside none;margin:13px 0 4px !important;padding: 0;"><li style="float:left;margin-left:2px;"> <a href="https://www.facebook.com/pages/Samtog/122544967924130" style="text-decoration:none"><img src="https://www.samtog.com/images/newsLetterSend/facebook.png" width="20px" height="20px" /></a></li><li style="float:left;margin-left:2px;"><a href="https://twitter.com/@SamtogGermany" style="text-decoration:none"><img src="https://www.samtog.com/images/newsLetterSend/twitter.png" width="20px" height="20px" /></a></li><li style="float:left;margin-left:2px;"><a href="https://plus.google.com/103245721260043672523" style="text-decoration:none"><img src="https://www.samtog.com/images/newsLetterSend/google.png" width="20px" height="20px" /></a></li></ul><p style=" color: #FFFFFF;font-size:11px;margin-top:15px;text-align:center;width:100%;margin-left:40px;cursor:default">To enable or disable mail notifiaction,change the option under user setting</p></div></div></body></html>';sendmailto($to,$subject,$mailBody);}mysql_query("insert into personalmessagethread (PmId, EmailId, Message, PostedDate) values ($PmId, '$emailId', '$topicMessage', '$dateTime')");$ptid=mysql_insert_id();if($topicAttachment!=''){$fileArray=json_decode(stripslashes($topicAttachment));foreach($fileArray as $filename){mysql_query("insert into personalmessageattachment (PtId, File) values ($ptid, '$filename')");}}getMyConversationThreadTableData($itemPerPage,$currentPageNumber,$PmId);}function deleteMyConversationThreadData($itemPerPage,$currentPageNumber,$currentThreadId,$PmId){$emailId=$_SESSION['emailId'];$resultDeleteImage=mysql_query("select * from personalmessageattachment where PtId=$currentThreadId");while($deleteImage=mysql_fetch_array($resultDeleteImage)){$imageName=$deleteImage['File'];$num=mysql_num_rows(mysql_query("select * from personalmessageattachment where File='$imageName'"));if($num>1){$path="../attachments/myConversation/".$imageName;if(is_file($path)){unlink($path);}}}mysql_query("delete from personalmessageattachment where PtId=$currentThreadId");mysql_query("delete from personalmessagethread where Id=$currentThreadId");}function editMyConversationThreadData($itemPerPage,$currentPageNumber,$PtId,$topicMessage,$topicAttachment,$dateTime,$PmId){$emailId=$_SESSION['emailId'];mysql_query("update personalmessagethread set Message='$topicMessage' where Id='$PtId'");mysql_query("delete from personalmessageattachment where PtId='$PtId'");if($topicAttachment!=''){$fileArray=json_decode(stripslashes($topicAttachment));foreach($fileArray as $filename){mysql_query("insert into personalmessageattachment (PtId, File) values ($PtId, '$filename')");}}getMyConversationThreadTableData($itemPerPage,$currentPageNumber,$PmId);}function deleteMyConversationMainData($PmId){$emailId=$_SESSION['emailId'];$row=mysql_fetch_array(mysql_query("select * from personalmessagemain where Id=$PmId"));$fromId=$row['FromId'];$fromStatus=$row['FromStatus'];$toStatus=$row['ToStatus'];if($fromStatus==0&&$toStatus==0){if(strtolower($fromId)==strtolower($emailId)){mysql_query("update personalmessagemain set FromStatus=1 where Id=$PmId");}else {mysql_query("update personalmessagemain set ToStatus=1 where Id=$PmId");}}else {$resultPtId=mysql_query("select * from personalmessagethread where PmId=$PmId ");while($getPtId=mysql_fetch_array($resultPtId)){$personalThreadId=$getPtId['Id'];$resultDeleteImage=mysql_query("select * from personalmessageattachment where PtId=$personalThreadId");while($deleteImage=mysql_fetch_array($resultDeleteImage)){$imageName=$deleteImage['File'];$num=mysql_num_rows(mysql_query("select * from personalmessageattachment where File='$imageName'"));if($num>1){$path="../attachments/myConversation/".$imageName;if(is_file($path)){unlink($path);}}}mysql_query("delete from personalmessageattachment where PtId=$personalThreadId");}mysql_query("delete from personalmessagethread where PmId=$PmId");mysql_query("delete from personalmessagemain where Id=$PmId");}}?>